<html>
  <head>
    <title>sm-web-component</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css" />
    <link
      rel="stylesheet"
      href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700"
      type="text/css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Rubik:wght@500&display=swap"
      rel="stylesheet"
    />
    <script src="https://code.getmdl.io/1.3.0/material.min.js" defer></script>
  </head>

  <body>
    <h1 class="title">Drop-in Web Component</h1>
    <h3 class="text">
      This demo shows how you can embed a Digital Person inside a plain HTML website.
    </h3>
    <div class="outer-container">
      <sm-video
        id="video"
        auto-connect="true"
        microphone-enabled="true"
        token-server="http://localhost:4210/auth/authorize"
      ></sm-video>
      <div class="container">
        <div class="mdl-card mdl-shadow--2dp">
          <div class="mdl-card__title">
            <h2 class="mdl-card__title-text">Event Messages</h2>
          </div>
          <div class="mdl-card__supporting-text">
            <div id="messages"></div>
          </div>
        </div>

        <div id="content">
          <img
            id="nzmap"
            class="hidden"
            data-sm-content="nzmap"
            src="https://lh3.googleusercontent.com/proxy/WGZfAf_WQtLL5vvoOu1RempHaed5K-a_73zD98PHx16zM_TTzp4Ot8aRvHbzCoJ2XMbS9QirC_nvGz5mztlC6lof1keya5jU4A"
            alt="nz"
          />
        </div>
      </div>
    </div>

    <div class="user-actions">
      <button id="mic" class="on" class="mdl-button--raised"></button>

      <button
        id="connect"
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"
      >
        Connect
      </button>
      <button
        id="disconnect"
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"
      >
        Disconnect
      </button>

      <button
        id="send-message"
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"
      >
        Send Message
      </button>
      <button
        id="stop-speaking"
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"
      >
        Stop Speaking
      </button>

      <button
        id="test-sdk-persona"
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"
      >
        Test SDK Persona
      </button>
      <button
        id="test-sdk-scene"
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"
      >
        Test SDK Scene
      </button>
      <button
        id="theme"
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"
      >
        Change Theme
      </button>
    </div>

    <script>
      const video = document.getElementById('video');
      let content = document.getElementById('content');
      let nzmap = document.getElementById('nzmap');
      let messages = document.getElementById('messages');
      let micButton = document.getElementById('mic');
      let micEnabled = true;
      let theme = 'default';

      const toggleMic = () => {
        micEnabled = !micEnabled;
        video.setMicrophoneEnabled(micEnabled);
        micButton.classList.remove(micEnabled ? 'off' : 'on');
        micButton.classList.add(micEnabled ? 'on' : 'off');
      };

      const toggleTheme = () => {
        theme = theme === 'default' ? 'none' : 'default';
        video.setAttribute('theme', theme);
      };

      const showImage = () => {
        var img = document.createElement('img');
        img.src =
          'https://www.tepapa.govt.nz/sites/default/files/styles/card_image_700x_525/public/ma_i521009_tepapa_apteryx-mantelli.jpg?itok=H4FzD8Lt';
        img.setAttribute('data-sm-content', 'nzkiwi');
        content.appendChild(img);
      };

      const addMessage = (text, color) => {
        let ele = document.createElement('p');
        ele.innerText = text;
        ele.style.color = color;
        messages.appendChild(ele);
      };

      let buttons = [
        { id: 'connect', action: () => video.connect() },
        { id: 'disconnect', action: () => video.disconnect() },
        { id: 'send-message', action: () => video.sendTextMessage('What is your national bird?') },
        { id: 'stop-speaking', action: () => video.stopSpeaking() },
        {
          id: 'test-sdk-persona',
          action: () => {
            video.persona()?.stopSpeaking();
            console.log(`test-sdk-persona stopSpeaking`);
          },
        },
        {
          id: 'test-sdk-scene',
          action: () =>
            console.log(`test-sdk-scene isCameraConnected: ${video.scene()?.isCameraConnected()}`),
        },
        {
          id: 'mic',
          action: () => toggleMic(),
        },
        {
          id: 'theme',
          action: () => toggleTheme(),
        },
      ];

      buttons.forEach((button) => {
        let buttonElement = document.getElementById(button.id);
        buttonElement.addEventListener('click', button.action);
      });

      video.addEventListener('connected', (e) => {
        addMessage('session connected', 'white');
      });

      video.addEventListener('disconnected', (e) => {
        addMessage('session disconnected', 'white');
      });

      video.addEventListener('userSpoke', (e) => {
        const text = e.detail.toLowerCase();
        console.log(text);
        addMessage('USER: ' + text, '#00FFFF');
        if (text.includes('hide map')) {
          nzmap.classList.remove('visible');
          nzmap.classList.add('hidden');
        }
      });

      video.addEventListener('dpSpoke', (e) => {
        const text = e.detail.toLowerCase();
        console.log(text);
        addMessage('DP: ' + text, '#00FF00');
        if (text.includes('new zealand')) {
          nzmap.classList.remove('hidden');
          nzmap.classList.add('visible');
        }
      });

      video.addEventListener('speechMarker', (e) => {
        const { name, arguments } = e.detail;
        console.log(name, arguments);
        const text = 'SPEECH MARKER: ' + name + ': [' + arguments.join(', ') + ']';
        addMessage(text, '#ED8138');
        if (arguments.includes('nzkiwi')) {
          showImage();
        }
      });
    </script>
  </body>
</html>

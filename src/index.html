<html>
  <head>
    <title>sm-web-component</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css" />
    <link
      rel="stylesheet"
      href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700"
      type="text/css"
    />
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  </head>

  <body>
    <h1 class="title">Drop-in Web Component</h1>
    <h3 class="text">
      This demo shows how you can embed a Digital Person inside a plain HTML website.
    </h3>
    <div class="container">
      <sm-video
        id="video"
        autoconnect="true"
        microphone-enabled="true"
        tokenserver="http://localhost:4210/auth/authorize"
      ></sm-video>
      <div class="content" id="content">
        <p id="msg">Event Messages</p>
        <img
          id="nzmap"
          class="hidden"
          data-sm-content="nzmap"
          src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7f/New_Zealand_locator_map_blank.svg/1200px-New_Zealand_locator_map_blank.svg.png"
          alt="nz"
        />
        <button class="hidden" onclick="showImage()">Show KIWI</button>
      </div>
    </div>

    <div class="user-actions">
      <button id="mic" class="on" class="mdl-button--raised"></button>

      <button
        id="connect"
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"
      >
        Connect
      </button>
      <button
        id="disconnect"
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"
      >
        Disconnect
      </button>

      <button
        id="send-message"
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"
      >
        Send Message
      </button>
      <button
        id="stop-speaking"
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"
      >
        Stop Speaking
      </button>

      <button
        id="test-sdk-persona"
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"
      >
        Test SDK Persona
      </button>
      <button
        id="test-sdk-scene"
        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"
      >
        Test SDK Scene
      </button>
    </div>

    <script>
      const video = document.getElementById('video');
      let content = document.getElementById('content');
      let nzmap = document.getElementById('nzmap');
      let msg = document.getElementById('msg');
      let micButton = document.getElementById('mic');
      let micEnabled = true;

      const toggleMic = () => {
        micEnabled = !micEnabled;
        video.setMicrophoneEnabled(micEnabled);
        micButton.classList.remove(micEnabled ? 'off' : 'on');
        micButton.classList.add(micEnabled ? 'on' : 'off');
      };

      const showImage = () => {
        var img = document.createElement('img');
        img.src =
          'https://www.experiencepurangi.co.nz/wp-content/uploads/2016/08/150723083731_1_900x6001.jpg';
        img.setAttribute('data-sm-content', 'nzkiwi');
        document.getElementById('content').appendChild(img);
      };

      let buttons = [
        { id: 'connect', action: () => video.connect() },
        { id: 'disconnect', action: () => video.disconnect() },
        { id: 'send-message', action: () => video.sendTextMessage('What is your national bird?') },
        { id: 'stop-speaking', action: () => video.stopSpeaking() },
        {
          id: 'test-sdk-persona',
          action: () => {
            video.persona()?.stopSpeaking();
            console.log(`test-sdk-persona stopSpeaking`);
          },
        },
        {
          id: 'test-sdk-scene',
          action: () =>
            console.log(`test-sdk-scene isCameraConnected: ${video.scene()?.isCameraConnected()}`),
        },
        {
          id: 'mic',
          action: () => toggleMic(),
        },
      ];

      buttons.forEach((button) => {
        let buttonElement = document.getElementById(button.id);
        buttonElement.addEventListener('click', button.action);
      });

      video.addEventListener('userSpoke', (e) => {
        const text = e.detail.toLowerCase();
        console.log(text);
        let ele = document.createElement('p');
        ele.innerText = text;
        ele.style.color = 'green';
        msg.appendChild(ele);
      });

      video.addEventListener('dpSpoke', (e) => {
        const text = e.detail.toLowerCase();
        console.log(text);
        let ele = document.createElement('p');
        ele.innerText = text;
        ele.style.color = 'blue';
        msg.appendChild(ele);
        if (text.includes('new zealand')) {
          nzmap.classList.remove('hidden');
          nzmap.classList.add('visible');
        }
      });

      video.addEventListener('speechMarker', (e) => {
        const { name, arguments } = e.detail;
        console.log(name, arguments);
        let ele = document.createElement('p');
        ele.innerText = name + ': [';
        arguments.forEach((e) => {
          ele.innerText += e;
          ele.innerText += ' ';
        });
        ele.innerText += ']';
        ele.style.color = 'red';
        msg.appendChild(ele);

        if (arguments.includes('nzkiwi')) {
          showImage();
        }
      });
    </script>
  </body>
</html>
